<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Database Karyawan</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f4f4f4;
    }
    h2 {
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #4CAF50;
      color: white;
    }
    input[type="text"], input[type="date"], select {
      padding: 5px;
      width: 100%;
      margin-bottom: 10px;
    }
    .form-group {
      margin-bottom: 10px;
    }
    button {
      padding: 8px 15px;
      margin: 5px 3px;
      border: none;
      cursor: pointer;
    }
    button.save { background-color: #4CAF50; color: white; }
    button.edit { background-color: #2196F3; color: white; }
    button.delete { background-color: #f44336; color: white; }
    button.download { background-color: #673AB7; color: white; }
    button.report { background-color: #FF9800; color: white; }
    .login-form {
      max-width: 400px;
      margin: 50px auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: white;
      text-align: center;
    }
    .review-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .review-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .error-log {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      color: #856404;
    }
    .logout-btn {
      float: right;
      background-color: #999;
    }
  </style>
</head>
<body>

  <!-- Layar Login -->
  <div id="loginScreen" class="login-form">
    <h2>Login Karyawan</h2>
    <div class="form-group">
      <input type="email" id="loginEmail" placeholder="Email" required>
    </div>
    <div class="form-group">
      <input type="password" id="loginPassword" placeholder="Password" required>
    </div>
    <button onclick="login()" class="save">Masuk</button>
  </div>

  <!-- Aplikasi Utama -->
  <div id="mainApp" style="display:none;">
    <h2>Database Karyawan</h2>
    <p><strong>Hai, <span id="userEmail">User</span></strong> | Role: <strong><span id="userRoleDisplay">...</span></strong></p>
    <button onclick="logout()" class="logout-btn">Keluar</button>

    <!-- Form Input -->
    <div id="form">
      <div class="form-group"><input type="text" id="nama" placeholder="Nama"></div>
      <div class="form-group"><input type="text" id="nik" placeholder="Nomor NIK"></div>
      <div class="form-group"><input type="text" id="alamat" placeholder="Alamat"></div>
      <div class="form-group"><input type="date" id="mulai"></div>
      <div class="form-group"><input type="text" id="jabatan" placeholder="Jabatan"></div>
      <div class="form-group"><input type="text" id="noreg" placeholder="Nomor Registrasi"></div>
      <div class="form-group">
        <select id="status">
          <option value="Aktif">Aktif</option>
          <option value="Non-Aktif">Non-Aktif</option>
        </select>
      </div>
      <div class="form-group"><input type="text" id="telp" placeholder="Nomor Telepon"></div>
      <button onclick="showReview()" class="save">Review & Simpan</button>
    </div>

    <!-- Tabel -->
    <table id="karyawanTable">
      <thead>
        <tr>
          <th>Nama</th>
          <th>NIK</th>
          <th>Alamat</th>
          <th>Mulai Masuk</th>
          <th>Jabatan</th>
          <th>No. Registrasi</th>
          <th>Status</th>
          <th>No. Telepon</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Tombol Download -->
    <div style="margin-top: 20px;">
      <button class="download" onclick="downloadPDF()">Download PDF</button>
      <button class="download" onclick="downloadExcel()">Download Excel</button>
    </div>
  </div>

  <!-- Modal Review -->
  <div id="reviewModal" class="review-modal">
    <div class="review-content">
      <h3>üîç Review Data Karyawan</h3>
      <div id="reviewData"></div>
      <p>Apakah data sudah benar?</p>
      <button onclick="saveData()">‚úÖ Ya, Simpan</button>
      <button onclick="reportError()" class="report">üì¢ Tidak, Lapor ke Admin</button>
      <button onclick="closeReview()" style="background:#999;">Batal</button>
    </div>
  </div>

  <!-- Firebase Libraries -->
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ============= GANTI INI DENGAN KONFIGURASI ANDA =============
    const firebaseConfig = {
  apiKey: "AIzaSyBWb4fTbNwzWMqII03ETGOcQHeFjB8ytlc",
  authDomain: "dashboard-karyawan.firebaseapp.com",
  projectId: "dashboard-karyawan",
  storageBucket: "dashboard-karyawan.firebasestorage.app",
  messagingSenderId: "566319746473",
  appId: "1:566319746473:web:06011d221a3ca3f38a88b8"
    };
    // ============================================================

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    let currentUser = null;
    let userRole = 'Operator';
    let pendingData = {};
    let editingItemId = null;

    // Login
    window.login = async function() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;

        // Ambil role dari Firestore
        const userDocRef = doc(db, 'users', currentUser.uid);
        const userDocSnap = await getDoc(userDocRef);

        if (userDocSnap.exists()) {
          userRole = userDocSnap.data().role;
        } else {
          alert('Akun tidak terdaftar. Hubungi Admin.');
          await signOut(auth);
          return;
        }

        // Tampilkan role
        document.getElementById('userEmail').innerText = email;
        document.getElementById('userRoleDisplay').innerText = userRole;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';

        loadKaryawan();
      } catch (error) {
        alert('Login gagal: ' + error.message);
      }
    };

    // Logout
    window.logout = async function() {
      await signOut(auth);
      location.reload();
    };

    // Tampilkan Review
    window.showReview = function() {
      const nama = document.getElementById('nama').value.trim();
      const nik = document.getElementById('nik').value.trim();
      if (!nama || !nik) {
        alert("Nama dan NIK wajib diisi.");
        return;
      }

      pendingData = {
        nama, nik,
        alamat: document.getElementById('alamat').value,
        mulai: document.getElementById('mulai').value,
        jabatan: document.getElementById('jabatan').value,
        noreg: document.getElementById('noreg').value,
        status: document.getElementById('status').value,
        telp: document.getElementById('telp').value
      };

      const reviewDiv = document.getElementById('reviewData');
      reviewDiv.innerHTML = `
        <p><strong>Nama:</strong> ${pendingData.nama}</p>
        <p><strong>NIK:</strong> ${pendingData.nik}</p>
        <p><strong>Alamat:</strong> ${pendingData.alamat || '-'}</p>
        <p><strong>Mulai:</strong> ${pendingData.mulai || '-'}</p>
        <p><strong>Jabatan:</strong> ${pendingData.jabatan || '-'}</p>
        <p><strong>No. Reg:</strong> ${pendingData.noreg || '-'}</p>
        <p><strong>Status:</strong> ${pendingData.status}</p>
        <p><strong>Telepon:</strong> ${pendingData.telp || '-'}</p>
      `;

      document.getElementById('reviewModal').style.display = 'flex';
    };

    // Simpan Data ke Firestore
    window.saveData = async function() {
      if (editingItemId) {
        await updateDoc(doc(db, 'karyawan', editingItemId), pendingData);
        editingItemId = null;
      } else {
        await addDoc(collection(db, 'karyawan'), pendingData);
      }
      closeReview();
      clearForm();
      loadKaryawan();
    };

    // Lapor ke Admin
    window.reportError = function() {
      const data = pendingData;
      const reportMsg = `üö® Laporan dari Operator:\n` +
        `Nama: ${data.nama}\nNIK: ${data.nik}\n` +
        `Kesalahan: Data tidak sesuai.\n` +
        `Mohon Admin periksa dan perbaiki.`;

      alert(reportMsg);
      closeReview();
      clearForm();
    };

    // Tutup Modal
    window.closeReview = function() {
      document.getElementById('reviewModal').style.display = 'none';
    };

    // Muat Data dari Firestore
    async function loadKaryawan() {
      const querySnapshot = await getDocs(collection(db, 'karyawan'));
      const table = document.getElementById('karyawanTable').getElementsByTagName('tbody')[0];
      table.innerHTML = '';
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const row = table.insertRow();
        row.innerHTML = `
          <td>${data.nama}</td>
          <td>${data.nik}</td>
          <td>${data.alamat}</td>
          <td>${data.mulai}</td>
          <td>${data.jabatan}</td>
          <td>${data.noreg}</td>
          <td>${data.status}</td>
          <td>${data.telp}</td>
          <td>
            ${userRole === 'Admin' 
              ? `<button class="edit" onclick="editItem('${doc.id}')">Edit</button>
                 <button class="delete" onclick="deleteItem('${doc.id}')">Hapus</button>`
              : `<button class="report" onclick="quickReport('${data.nama}', '${data.nik}')">Lapor</button>`
            }
          </td>
        `;
      });
    }

    // Edit Item
    window.editItem = function(id) {
      editingItemId = id;
      const row = event.target.parentNode.parentNode;
      const cells = row.getElementsByTagName('td');
      document.getElementById('nama').value = cells[0].innerText;
      document.getElementById('nik').value = cells[1].innerText;
      document.getElementById('alamat').value = cells[2].innerText;
      document.getElementById('mulai').value = cells[3].innerText;
      document.getElementById('jabatan').value = cells[4].innerText;
      document.getElementById('noreg').value = cells[5].innerText;
      document.getElementById('status').value = cells[6].innerText;
      document.getElementById('telp').value = cells[7].innerText;
    };

    // Hapus Item
    window.deleteItem = async function(id) {
      if (confirm('Hapus data ini?')) {
        await deleteDoc(doc(db, 'karyawan', id));
        loadKaryawan();
      }
    };

    // Lapor Cepat dari Tabel
    window.quickReport = function(nama, nik) {
      alert(`Operator melaporkan \nNama: ${nama}\nNIK: ${nik}\n\nMohon Admin periksa dan perbaiki.`);
    };

    // Clear Form
    function clearForm() {
      document.getElementById('nama').value = '';
      document.getElementById('nik').value = '';
      document.getElementById('alamat').value = '';
      document.getElementById('mulai').value = '';
      document.getElementById('jabatan').value = '';
      document.getElementById('noreg').value = '';
      document.getElementById('status').value = 'Aktif';
      document.getElementById('telp').value = '';
    }

    // Cek Auth State
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Sudah ditangani di login
      }
    });

    // Ekspor PDF
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Data Karyawan", 10, 10);
      const headers = [["Nama", "NIK", "Alamat", "Mulai", "Jabatan", "No. Reg", "Status", "Telp"]];
      const data = Array.from(document.querySelectorAll("#karyawanTable tbody tr")).map(tr => [
        tr.cells[0].innerText,
        tr.cells[1].innerText,
        tr.cells[2].innerText,
        tr.cells[3].innerText,
        tr.cells[4].innerText,
        tr.cells[5].innerText,
        tr.cells[6].innerText,
        tr.cells[7].innerText
      ]);
      doc.autoTable({ head: headers, body: data, startY: 20 });
      doc.save("karyawan.pdf");
    }

    // Ekspor Excel
    function downloadExcel() {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([
        ["Nama", "NIK", "Alamat", "Mulai", "Jabatan", "No. Reg", "Status", "Telp"],
        ...Array.from(document.querySelectorAll("#karyawanTable tbody tr")).map(tr => [
          tr.cells[0].innerText,
          tr.cells[1].innerText,
          tr.cells[2].innerText,
          tr.cells[3].innerText,
          tr.cells[4].innerText,
          tr.cells[5].innerText,
          tr.cells[6].innerText,
          tr.cells[7].innerText
        ])
      ]);
      XLSX.utils.book_append_sheet(wb, ws, "Karyawan");
      XLSX.writeFile(wb, "karyawan.xlsx");
    }
  </script>
</body>
</html>
